from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from src.api.v1 import community, raffle, notification, community_modal, nested_community_card, notification_card
from src.api.v1.raffle import raffle_cards_router
from src.api.v1.notification import settings_router
from src.core.config import settings
from src.core.logging import setup_logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è Swagger
app = FastAPI(
    title="VK Randomizer API",
    description="""
    ## API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏ –≤ VK —Å–æ–æ–±—â–µ—Å—Ç–≤–∞—Ö
    
    ### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
    - üéØ –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏
    - üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞–º–∏
    - üîî –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    - üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
    
    ### –†–æ–∑—ã–≥—Ä—ã—à–∏
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ —É—á–∞—Å—Ç–∏—è:
    - –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
    - –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 5 —à—Ç)
    - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (–ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ, Telegram)
    - –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–µ —Ç–µ–≥–∏
    - –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–ø–æ –≤—Ä–µ–º–µ–Ω–∏/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º)
    - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ (—Å–∫—Ä—ã—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∏—Å–∫–ª—é—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—é)
    
    ### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
    """,
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc",
    openapi_url="/openapi.json",
    contact={
        "name": "VK Randomizer Team",
        "email": "support@vkrandomizer.com",
    },
    license_info={
        "name": "MIT",
        "url": "https://opensource.org/licenses/MIT",
    },
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.CORS_ORIGINS,
    allow_credentials=settings.CORS_ALLOW_CREDENTIALS,
    allow_methods=settings.CORS_ALLOW_METHODS,
    allow_headers=settings.CORS_ALLOW_HEADERS,
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
setup_logging()

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–æ–≤
app.include_router(community.router, prefix="/api/v1", tags=["Communities"])
app.include_router(raffle.router, prefix="/api/v1", tags=["Raffles"])
app.include_router(notification.router, prefix="/api/v1", tags=["Notifications"])
app.include_router(community_modal.router, prefix="/api/v1", tags=["CommunityModals"])
app.include_router(nested_community_card.router, prefix="/api/v1", tags=["NestedCommunityCards"])
app.include_router(notification_card.router, prefix="/api/v1", tags=["NotificationCards"])
app.include_router(raffle_cards_router, prefix="/api/v1", tags=["RaffleCards"])
app.include_router(settings_router, prefix="/api/v1", tags=["NotificationSettings"])
app.mount("/photos", StaticFiles(directory="uploaded_photos"), name="photos")

@app.get("/", tags=["Root"])
async def root():
    """
    –ö–æ—Ä–Ω–µ–≤–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç API.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–∏—Å–µ.
    """
    return {
        "message": "VK Randomizer API",
        "version": "1.0.0",
        "docs": "/docs",
        "redoc": "/redoc"
    }

@app.get("/health", tags=["Health"])
async def health_check():
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ API.
    """
    return {"status": "healthy", "timestamp": "2025-01-18T12:00:00Z"}
